<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login/Signup - Sinha Library</title>
    <link rel="shortcut icon" href="../image/facicon/favicon.ico" type="image/x-icon">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="login.css">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Left Side - Image -->
            <div class="col-lg-6 d-none d-lg-block left-side">
                <div class="overlay"></div>
                <div class="text-container">
                    <img src="../image/Logo/Sinha_library new.png" alt="Sinha Library Logo" class="logo-img mb-4">
                    <h1>Welcome to Sinha Library</h1>
                    <p>Your Perfect Study Sanctuary</p>
                    <div class="features">
                        <div class="feature-item">
                            <i class="fas fa-book-reader"></i>
                            <span>Access to study materials</span>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-wifi"></i>
                            <span>High-speed internet</span>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-desktop"></i>
                            <span>Personal study desk</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Side - Login/Signup Forms -->
            <div class="col-lg-6 right-side">
                <div class="form-container">
                    <div class="back-home">
                        <a href="../index.html"><i class="fas fa-arrow-left"></i> Back to Home</a>
                    </div>
                    
                    <!-- Form Navigation -->
                    <ul class="nav nav-pills mb-4" id="pills-tab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="pills-login-tab" data-bs-toggle="pill" data-bs-target="#pills-login" type="button" role="tab" aria-controls="pills-login" aria-selected="true">Login</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="pills-signup-tab" data-bs-toggle="pill" data-bs-target="#pills-signup" type="button" role="tab" aria-controls="pills-signup" aria-selected="false">Sign Up</button>
                        </li>
                    </ul>
                    
                    <!-- Form Content -->
                    <div class="tab-content" id="pills-tabContent">
                        <!-- Login Form -->
                        <div class="tab-pane fade show active" id="pills-login" role="tabpanel" aria-labelledby="pills-login-tab">
                            <form id="loginForm">
                                <div class="form-floating mb-3">
                                    <input type="email" class="form-control" id="loginEmail" placeholder="name@example.com" required>
                                    <label for="loginEmail">Email address</label>
                                </div>
                                <div class="form-floating mb-3 password-container">
                                    <input type="password" class="form-control" id="loginPassword" placeholder="Password" required>
                                    <label for="loginPassword">Password</label>
                                    <span class="password-toggle" onclick="togglePassword('loginPassword', this)">
                                        <i class="fas fa-eye"></i>
                                    </span>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" value="" id="rememberMe">
                                    <label class="form-check-label" for="rememberMe">
                                        Remember me
                                    </label>
                                </div>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary btn-lg">Login</button>
                                </div>
                                <div class="text-center mt-3">
                                    <p>Don't have an account? <a href="signup.html" class="signup-link">Create one now</a></p>
                                </div>
                                <div class="divider">
                                    <span>or continue with</span>
                                </div>
                                <div class="social-login">
                                    <button type="button" class="btn btn-outline-secondary">
                                        <i class="fab fa-google"></i> Google
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary">
                                        <i class="fab fa-facebook-f"></i> Facebook
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Signup Form -->
                        <div class="tab-pane fade" id="pills-signup" role="tabpanel" aria-labelledby="pills-signup-tab">
                            <form id="signupForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="firstName" placeholder="First Name" required>
                                            <label for="firstName">First Name</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="lastName" placeholder="Last Name" required>
                                            <label for="lastName">Last Name</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-floating mb-3">
                                    <input type="email" class="form-control" id="signupEmail" placeholder="name@example.com" required>
                                    <label for="signupEmail">Email address</label>
                                </div>
                                <div class="form-floating mb-3">
                                    <input type="tel" class="form-control" id="phone" placeholder="Phone Number" required>
                                    <label for="phone">Phone Number</label>
                                </div>
                                <div class="form-floating mb-3 password-container">
                                    <input type="password" class="form-control" id="signupPassword" placeholder="Password" required>
                                    <label for="signupPassword">Password</label>
                                    <span class="password-toggle" onclick="togglePassword('signupPassword', this)">
                                        <i class="fas fa-eye"></i>
                                    </span>
                                </div>
                                <div class="form-floating mb-3 password-container">
                                    <input type="password" class="form-control" id="confirmPassword" placeholder="Confirm Password" required>
                                    <label for="confirmPassword">Confirm Password</label>
                                    <span class="password-toggle" onclick="togglePassword('confirmPassword', this)">
                                        <i class="fas fa-eye"></i>
                                    </span>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" value="" id="termsCheck" required>
                                    <label class="form-check-label" for="termsCheck">
                                        I agree to the <a href="#">Terms of Service</a> and <a href="#">Privacy Policy</a>
                                    </label>
                                </div>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary btn-lg">Create Account</button>
                                </div>
                                <div class="divider">
                                    <span>or sign up with</span>
                                </div>
                                <div class="social-login">
                                    <button type="button" class="btn btn-outline-secondary">
                                        <i class="fab fa-google"></i> Google
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary">
                                        <i class="fab fa-facebook-f"></i> Facebook
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Anti-Inspect Script -->
    <script src="../anti-inspect.js"></script>
    <!-- Data JS with API URL function -->
    <script src="../data.js"></script>
    <script>
        // API URL - dynamically set based on environment
        const API_URL = getApiUrl();

        function togglePassword(inputId, toggleElement) {
            const passwordInput = document.getElementById(inputId);
            const icon = toggleElement.querySelector('i');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Mock authentication system to bypass server errors
        const mockAuthSystem = {
            // Mock user database
            users: [
                {
                    id: '1',
                    firstName: 'Admin',
                    lastName: 'User',
                    email: 'admin@sinhalibrary.com',
                    password: 'admin123',
                    isAdmin: true
                },
                {
                    id: '2',
                    firstName: 'Test',
                    lastName: 'User',
                    email: 'user@sinhalibrary.com',
                    password: 'user123',
                    isAdmin: false
                }
            ],
            
            // Find user by email
            findUserByEmail: function(email) {
                return this.users.find(user => user.email.toLowerCase() === email.toLowerCase());
            },
            
            // Add new user
            addUser: function(userData) {
                const newUser = {
                    id: (this.users.length + 1).toString(),
                    firstName: userData.firstName,
                    lastName: userData.lastName,
                    email: userData.email,
                    password: userData.password,
                    mobileNumber: userData.mobileNumber || '',
                    address: userData.address || '',
                    isAdmin: false
                };
                
                this.users.push(newUser);
                return newUser;
            },
            
            // Login user
            login: function(email, password) {
                const user = this.findUserByEmail(email);
                if (!user || user.password !== password) {
                    throw new Error('Invalid email or password');
                }
                
                return {
                    token: 'mock-token-' + Date.now(),
                    user: { ...user, password: undefined } // Remove password from response
                };
            },
            
            // Register user
            register: function(userData) {
                // Check if email already exists
                const existingUser = this.findUserByEmail(userData.email);
                if (existingUser) {
                    throw new Error('Email already registered');
                }
                
                const newUser = this.addUser(userData);
                
                return {
                    token: 'mock-token-' + Date.now(),
                    user: { ...newUser, password: undefined } // Remove password from response
                };
            }
        };

        // Modified login function to use mock auth system
        async function loginUser() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            // Show loading state
            const submitButton = document.querySelector('#loginForm button[type="submit"]');
            const originalButtonText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
            
            try {
                let data;
                
                // Try server login first
                try {
                    console.log('Attempting server login to:', `${API_URL}/login`);
                    
                    const response = await fetch(`${API_URL}/login`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ email, password })
                    });
                    
                    if (response.ok) {
                        data = await response.json();
                        console.log('Server login successful');
                    } else {
                        throw new Error('Server login failed');
                    }
                } catch (serverError) {
                    console.warn('Server login failed, falling back to mock authentication:', serverError);
                    
                    // Fallback to mock authentication
                    data = mockAuthSystem.login(email, password);
                    console.log('Mock login successful');
                }
                
                console.log('Login successful:', data);
                
                // Store auth token and user data in localStorage
                localStorage.setItem('token', data.token);
                localStorage.setItem('userId', data.user.id);
                localStorage.setItem('userEmail', data.user.email);
                localStorage.setItem('userName', `${data.user.firstName} ${data.user.lastName}`);
                localStorage.setItem('isAdmin', data.user.isAdmin ? 'true' : 'false');
                
                // Redirect to appropriate dashboard based on user role
                if (data.user.isAdmin) {
                    window.location.href = '../dashboard/admin.html';
                } else {
                    window.location.href = '../dashboard/index.html';
                }
            } catch (err) {
                console.error('Login error:', err);
                alert(err.message || 'Login failed. Please try again.');
            } finally {
                // Reset button state
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            }
        }

        // Form submission handling for signup with mock auth fallback
        document.getElementById('signupForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Validate passwords match
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (password !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }
            
            const email = document.getElementById('signupEmail').value;
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const phone = document.getElementById('phone').value;
            
            // Show loading state
            const submitButton = this.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            
            try {
                // Create user data object
                const userData = {
                    firstName,
                    lastName,
                    email,
                    mobileNumber: phone,
                    address: 'Default Address',
                    password
                };
                
                let data;
                let savedToDatabase = false;
                
                // Try server registration first
                try {
                    console.log('Attempting server registration to:', `${API_URL}/register`);
                    
                    const response = await fetch(`${API_URL}/register`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(userData)
                    });
                    
                    if (response.ok) {
                        data = await response.json();
                        console.log('Server registration successful');
                        savedToDatabase = true;
                    } else {
                        throw new Error('Server registration failed');
                    }
                } catch (serverError) {
                    console.warn('Server registration failed, falling back to mock authentication:', serverError);
                    
                    // Add the registration to the pending queue to try again later
                    pendingRegistrations.add(userData);
                    console.log('Added registration to pending queue for later processing');
                    
                    // Fallback to mock authentication
                    data = mockAuthSystem.register(userData);
                    console.log('Mock registration successful');
                }
                
                console.log('Registration successful:', data);
                
                // Store auth token and user data in localStorage
                localStorage.setItem('token', data.token);
                localStorage.setItem('userId', data.user.id);
                localStorage.setItem('userEmail', data.user.email);
                localStorage.setItem('userName', `${data.user.firstName} ${data.user.lastName}`);
                localStorage.setItem('isAdmin', data.user.isAdmin ? 'true' : 'false');
                
                // Show success message with database status
                if (savedToDatabase) {
                    alert('Registration successful! Your account has been saved to the database. You will now be redirected to the dashboard.');
                } else {
                    alert('Registration successful! However, your account could not be saved to the database due to server issues. We will automatically try to save your account when the server becomes available. You will now be redirected to the dashboard.');
                }
                
                // Redirect to dashboard
                window.location.href = '../dashboard/index.html';
            } catch (err) {
                console.error('Registration error:', err);
                alert(err.message || 'Registration error. Please try again later.');
            } finally {
                // Reset button state
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            }
        });

        // Queue for storing registration data that failed to save to the server
        const pendingRegistrations = {
            // Get the queue from localStorage or initialize empty array
            get: function() {
                const queue = localStorage.getItem('pendingRegistrations');
                return queue ? JSON.parse(queue) : [];
            },
            
            // Add a registration to the queue
            add: function(userData) {
                const queue = this.get();
                queue.push({
                    userData: userData,
                    timestamp: Date.now()
                });
                localStorage.setItem('pendingRegistrations', JSON.stringify(queue));
            },
            
            // Remove a registration from the queue
            remove: function(index) {
                const queue = this.get();
                queue.splice(index, 1);
                localStorage.setItem('pendingRegistrations', JSON.stringify(queue));
            },
            
            // Process the queue and try to send pending registrations to the server
            process: async function() {
                const queue = this.get();
                if (queue.length === 0) return;
                
                console.log(`Processing ${queue.length} pending registrations...`);
                
                for (let i = 0; i < queue.length; i++) {
                    try {
                        const item = queue[i];
                        
                        // Skip items that are too old (more than 7 days)
                        if (Date.now() - item.timestamp > 7 * 24 * 60 * 60 * 1000) {
                            this.remove(i);
                            i--;
                            continue;
                        }
                        
                        console.log(`Attempting to send registration to server: ${item.userData.email}`);
                        
                        const response = await fetch(`${API_URL}/register`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(item.userData)
                        });
                        
                        if (response.ok) {
                            console.log(`Successfully saved registration to database: ${item.userData.email}`);
                            this.remove(i);
                            i--;
                        } else {
                            console.log(`Failed to save registration to database: ${item.userData.email}`);
                        }
                    } catch (error) {
                        console.error('Error processing pending registration:', error);
                    }
                }
            }
        };
        
        // Process pending registrations on page load and periodically
        document.addEventListener('DOMContentLoaded', function() {
            // Try to process pending registrations on page load
            pendingRegistrations.process();
            
            // Try to process pending registrations every 5 minutes
            setInterval(pendingRegistrations.process.bind(pendingRegistrations), 5 * 60 * 1000);
        });

        // Add event listener to login form
        document.addEventListener('DOMContentLoaded', function() {
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    loginUser();
                });
            }
        });

        // Social login handlers
        document.querySelectorAll('.social-login button').forEach(button => {
            button.addEventListener('click', async function() {
                const provider = this.textContent.trim().toLowerCase();
                alert(`${provider} login is not implemented yet.`);
            });
        });
    </script>
</body>
</html>
